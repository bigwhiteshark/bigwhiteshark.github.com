---
title: WebGL中的光照
date: 2017-08-09 18:00
tags: [webgl, light]
---

## 本节内容

明暗、阴影、不同光的类型：点光源、平行光和散射光。
物体表面反射光线的方式：漫反射和环境反射。
编写代码实现光照效果。

## 光照原理

现实世界中的物体被光线照射时，会反射一部分光，只有反射光线进入你的眼睛时，你才能够看到物体并辨认出它的颜色。白色物体反射白光，白光进入你的眼睛时，才能看到物体是白色的。

现实世界中，当光线照到物体上时，发生两个重要的现象：
* 根据光源和光线方向，物体不同表面的明暗程度变得不一致。
* 根据光源和光线方向，物体向地面投下了影子。

在生活中常常会注意到阴影，却很少注意明暗差异。实际上明暗差异给了物体立体感，虽然难以察觉，但它始终存在。

在三维图形学中术语 **着色**(shading) 的真正含义就是，根据光照条件重建“物体各表面明暗不一致的效果”的过程。物体向地面投下影子的现象，又被称为 **阴影** (shadowing)。

在讨论着色过程之前，考虑两件事情：
* 发出光线的光源类型。
* 物体表面如何反射光线。 

光源类型：
* 平行光：平行光的光线是相互平行的，具有方向性。类似于自然中的太阳光。可以用一个方向和一个颜色来定义。
* 点光源：从一个点向周围的所有方向发现的光，类似于人造的灯泡的光，如灯泡、火焰。
* 环境光：也叫间接光，真实世界中非直射光，是指哪些经光源（点或平行光源）发出后，被墙壁等物体多次反射，然后照到物体表面上的光，环境光从各个角度照射物体，其强度都是一致的。不用指定位置与方向，只需要指定颜色即可。
* 聚光灯光：模拟电筒、车前灯，探照灯等。

反射类型：
* 漫反射：针对平行光或点光源而言的。漫反射的反射光在各个方向上是均匀的。大部分物体表面是粗糙的，如纸张、岩石、塑料等，在这种情况下反射光就会以不固定的角度反射出去。漫反射就是针对后一种情况而建立的理想反射模型 。

  ![漫反射](/assets/image/blog/diffuse.png)

  漫反射中，反射光的颜色取决于入射光的颜色、表面的基底色、入射与表面形成的入射角。将入射角定义为入射光与法线形成的夹角，并用θ表示，那么漫反射光的颜色可以根据下式得到：

  ![漫反射公式](/assets/image/blog/diffuse-formula.png)

因为漫反射光在各个方向上都是“均匀”的，所以从任何角度上看去其强度都相等，如下

![漫反射光方向](/assets/image/blog/diffuse-direction.png)

* 环境反射：针对环境光而言。反射光的方向可以认为就是入射光的方向。由于环境光照射物体的方式就是各方向均匀、强度相等的，所以反射光也是各方向均匀。

  ![环境反射公式](/assets/image/blog/ambient-formula.png)

  这里的入射光实际上也就是环境光的颜色。

  ![环境光方向](/assets/image/blog/ambient-direction.png)

  当漫反射和环境反射同时存在时，将两者加起来，就会得到物体最终被观察到的颜色：

  ![物体最终颜色](/assets/image/blog/material-color.png)

  ​

  ## 平行光下的漫反射

  漫反射的反射光，其颜色与入射光在入射点的入射角θ有关。平行光入射产生的漫反射的颜色很容易计算。因为平行光的方向是唯一的，对于同一平面上的所有点，入射角是相同的。根据上面的公式来计算漫反射光的颜色：

  ![漫反射公式](/assets/image/blog/diffuse-formula.png)

  用到三项数据：

  * 平行入射光的颜色
  * 表面的基底色（物体的颜色）
  * 入射光与表面形成的入射角θ

  计算反射光颜色时，我们要对RGB值的三个分量逐个相乘。

  根据光线和表面的方向计算入射角。通过计算两个矢量的点积，来计算这两个矢量的夹角余弦值cosθ。点积的计算公升：

  ![点积](/assets/image/blog/dot.png)

  ```
  其中，||符号是表示矢量的长度。如果两个矢量的长度都是1.0，那么点积的结果就是cosθ值。如果n为（nx,ny,nz）,l为（lx,ly,lz）,那么 n·l= nx * lx + ny * ly + nz * lz。该公式可由余弦定理得到。
  ```

  ![反射光公式2](/assets/image/blog/diffuse-format-2.png)

  注意，其一光线方向矢量与表面法线矢量长度必须为1，否则反射光的颜色就会过暗或过亮。将一个矢量长度调整为1，同时保持方向不变的过程称之为 **归一化**（normalization）。

  “光线方向”，实际就是入射方向的反方向。

  ![光线方向](/assets/image/blog/light-direction.png)

